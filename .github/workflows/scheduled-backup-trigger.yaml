name: Scheduled Backup Trigger

# This workflow runs on a schedule and triggers the backup workflow on both dev and main branches.
#
# IMPORTANT: GitHub Actions scheduled workflows only run on the default branch by default.
# This is a workaround to ensure scheduled backups run on both dev and main branches.
#
# How it works:
# 1. This workflow runs on a schedule (currently set for testing at 10:51 UTC, normally 08:16 UTC daily)
# 2. It triggers the backup.yaml workflow on both 'main' and 'dev' branches
# 3. Each branch gets its own backup run, committing to its respective branch
# 4. Each branch trigger is independent - failure of one doesn't block the other
# 5. Retry logic handles transient API failures automatically
#
# Note: The backup.yaml workflow must have 'workflow_dispatch' enabled to be triggered this way.

on:
  schedule:
    - cron: "51 10 * * *" # Testing: runs at 10:51 UTC (10 minutes from now). Change back to "16 8 * * *" for daily at 08:16 UTC

jobs:
  trigger-backups:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Fail if workflow takes longer than 10 minutes
    permissions:
      contents: read
      actions: write # Required to trigger other workflows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate trigger token
        id: validate-token
        uses: actions/github-script@v7
        continue-on-error: false
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
          script: |
            try {
              // Test token by making a simple API call
              const repo = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              console.log('✅ Token validated successfully');
              core.setOutput('valid', 'true');
            } catch (error) {
              console.error('❌ Token validation failed:', error.message);
              console.error('Please check that WORKFLOW_TRIGGER_TOKEN secret is set and has correct permissions');
              throw new Error('Invalid or missing WORKFLOW_TRIGGER_TOKEN');
            }

      - name: Trigger backup on main branch
        id: trigger-main
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
          script: |
            const maxRetries = 3;
            const initialDelay = 5000; // 5 seconds
            let lastError;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'backup.yaml',
                  ref: 'main'
                });
                console.log(`✅ Successfully triggered backup workflow on main branch (attempt ${attempt})`);
                core.setOutput('success', 'true');
                core.setOutput('attempt', attempt.toString());
                return;
              } catch (error) {
                lastError = error;
                const isRetryable = error.status === 429 || // Rate limit
                                  error.status >= 500 ||     // Server errors
                                  error.message.includes('ECONNRESET') ||
                                  error.message.includes('ETIMEDOUT');
                
                if (isRetryable && attempt < maxRetries) {
                  const delay = initialDelay * Math.pow(2, attempt - 1); // Exponential backoff
                  console.log(`⚠️ Attempt ${attempt} failed (${error.message}), retrying in ${delay/1000}s...`);
                  await new Promise(resolve => setTimeout(resolve, delay));
                  continue;
                }
                
                // Non-retryable error or max retries reached
                console.error(`❌ Failed to trigger backup on main branch after ${attempt} attempt(s):`, error.message);
                if (error.status === 404) {
                  console.error('   Workflow file "backup.yaml" not found. Please verify the workflow exists.');
                } else if (error.status === 403) {
                  console.error('   Permission denied. Please check token permissions.');
                }
                throw error;
              }
            }
            throw lastError;

      - name: Verify main branch backup triggered
        id: verify-main
        if: steps.trigger-main.outcome == 'success'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
          script: |
            // Wait for workflow to appear in API
            await new Promise(resolve => setTimeout(resolve, 15000));

            try {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'backup.yaml',
                branch: 'main',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const latestRun = runs.data.workflow_runs[0];
                const runAge = Date.now() - new Date(latestRun.created_at).getTime();
                if (runAge < 60000) { // Created within last minute
                  console.log(`✅ Verified: Backup workflow on main branch started (run #${latestRun.id})`);
                  core.setOutput('verified', 'true');
                  return;
                }
              }
              console.log('⚠️ Could not verify backup workflow start (may still be processing)');
            } catch (error) {
              console.log('⚠️ Verification check failed (non-critical):', error.message);
            }

      - name: Trigger backup on dev branch
        id: trigger-dev
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
          script: |
            const maxRetries = 3;
            const initialDelay = 5000; // 5 seconds
            let lastError;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'backup.yaml',
                  ref: 'dev'
                });
                console.log(`✅ Successfully triggered backup workflow on dev branch (attempt ${attempt})`);
                core.setOutput('success', 'true');
                core.setOutput('attempt', attempt.toString());
                return;
              } catch (error) {
                lastError = error;
                const isRetryable = error.status === 429 || // Rate limit
                                  error.status >= 500 ||     // Server errors
                                  error.message.includes('ECONNRESET') ||
                                  error.message.includes('ETIMEDOUT');
                
                if (isRetryable && attempt < maxRetries) {
                  const delay = initialDelay * Math.pow(2, attempt - 1); // Exponential backoff
                  console.log(`⚠️ Attempt ${attempt} failed (${error.message}), retrying in ${delay/1000}s...`);
                  await new Promise(resolve => setTimeout(resolve, delay));
                  continue;
                }
                
                // Non-retryable error or max retries reached
                console.error(`❌ Failed to trigger backup on dev branch after ${attempt} attempt(s):`, error.message);
                if (error.status === 404) {
                  console.error('   Workflow file "backup.yaml" not found. Please verify the workflow exists.');
                } else if (error.status === 403) {
                  console.error('   Permission denied. Please check token permissions.');
                }
                throw error;
              }
            }
            throw lastError;

      - name: Verify dev branch backup triggered
        id: verify-dev
        if: steps.trigger-dev.outcome == 'success'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
          script: |
            // Wait for workflow to appear in API
            await new Promise(resolve => setTimeout(resolve, 15000));

            try {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'backup.yaml',
                branch: 'dev',
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const latestRun = runs.data.workflow_runs[0];
                const runAge = Date.now() - new Date(latestRun.created_at).getTime();
                if (runAge < 60000) { // Created within last minute
                  console.log(`✅ Verified: Backup workflow on dev branch started (run #${latestRun.id})`);
                  core.setOutput('verified', 'true');
                  return;
                }
              }
              console.log('⚠️ Could not verify backup workflow start (may still be processing)');
            } catch (error) {
              console.log('⚠️ Verification check failed (non-critical):', error.message);
            }

      - name: Backup trigger summary
        if: always()
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║           SCHEDULED BACKUP TRIGGER SUMMARY                      ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          MAIN_STATUS="${{ steps.trigger-main.outcome }}"
          DEV_STATUS="${{ steps.trigger-dev.outcome }}"
          MAIN_ATTEMPT="${{ steps.trigger-main.outputs.attempt }}"
          DEV_ATTEMPT="${{ steps.trigger-dev.outputs.attempt }}"

          echo "Main Branch:"
          if [ "$MAIN_STATUS" = "success" ]; then
            echo "  ✅ Backup triggered successfully"
            [ -n "$MAIN_ATTEMPT" ] && [ "$MAIN_ATTEMPT" != "1" ] && echo "  ⚠️ Required $MAIN_ATTEMPT attempts (retries used)"
            if [ "${{ steps.verify-main.outcome }}" = "success" ]; then
              echo "  ✅ Backup workflow verified as started"
            else
              echo "  ⚠️ Could not verify backup start (may still be processing)"
            fi
          else
            echo "  ❌ Failed to trigger backup"
            echo "  Check logs above for error details"
          fi

          echo ""
          echo "Dev Branch:"
          if [ "$DEV_STATUS" = "success" ]; then
            echo "  ✅ Backup triggered successfully"
            [ -n "$DEV_ATTEMPT" ] && [ "$DEV_ATTEMPT" != "1" ] && echo "  ⚠️ Required $DEV_ATTEMPT attempts (retries used)"
            if [ "${{ steps.verify-dev.outcome }}" = "success" ]; then
              echo "  ✅ Backup workflow verified as started"
            else
              echo "  ⚠️ Could not verify backup start (may still be processing)"
            fi
          else
            echo "  ❌ Failed to trigger backup"
            echo "  Check logs above for error details"
          fi

          echo ""
          echo "╔════════════════════════════════════════════════════════════════╗"

          # Exit with error only if both branches failed
          if [ "$MAIN_STATUS" != "success" ] && [ "$DEV_STATUS" != "success" ]; then
            echo "❌ CRITICAL: Both branch backups failed to trigger"
            exit 1
          elif [ "$MAIN_STATUS" != "success" ] || [ "$DEV_STATUS" != "success" ]; then
            echo "⚠️ WARNING: One branch backup failed to trigger (see details above)"
            exit 0  # Partial success is acceptable
          else
            echo "✅ SUCCESS: Both branch backups triggered successfully"
            exit 0
          fi
